stages:
  - build
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  NODE_VERSION: "20"

# ç¼“å­˜é…ç½®
.cache_config: &cache_config
  cache:
    key:
      files:
        - package-lock.json
        - src-tauri/Cargo.lock
    paths:
      - .cargo/
      - node_modules/
      - src-tauri/target/

# çŽ¯å¢ƒåˆ¤æ–­
.determine_env: &determine_env
  - |
    if [ -n "$CI_COMMIT_TAG" ]; then
      ENV="prod"
    elif [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "master" ]; then
      ENV="uat"
    else
      ENV="test"
    fi
    echo "ðŸŒ Building for environment: $ENV"
    export BUILD_ENV=$ENV

# åŠ è½½çŽ¯å¢ƒå˜é‡
.load_env: &load_env
  - |
    ENV_FILE=".env.$BUILD_ENV"
    if [ ! -f "$ENV_FILE" ]; then
      echo "âŒ Environment file not found: $ENV_FILE"
      exit 1
    fi
    
    # å¯¼å‡ºçŽ¯å¢ƒå˜é‡
    set -a
    source "$ENV_FILE"
    set +a
    
    echo "âœ… Environment variables loaded from $ENV_FILE"
    echo "  - Product Name: $TAURI_PRODUCT_NAME"
    echo "  - Bundle ID: $TAURI_BUNDLE_IDENTIFIER"

# æ›´æ–°é…ç½®æ–‡ä»¶
.update_config: &update_config
  - |
    cp src-tauri/tauri.conf.json src-tauri/tauri.conf.json.bak
    
    # ä½¿ç”¨ jq ä¿®æ”¹é…ç½®
    jq --arg name "$TAURI_PRODUCT_NAME" --arg id "$TAURI_BUNDLE_IDENTIFIER" \
      '.productName = $name | .identifier = $id' \
      src-tauri/tauri.conf.json.bak > src-tauri/tauri.conf.json
    
    echo "âœ… Updated tauri.conf.json"

# macOS æž„å»ºï¼ˆApple Siliconï¼‰
build:macos-aarch64:
  stage: build
  tags:
    - macos
    - arm64
  <<: *cache_config
  before_script:
    - *determine_env
    - *load_env
    - *update_config
    # å®‰è£…ä¾èµ–
    - brew install node@${NODE_VERSION} || true
    - npm ci
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup target add aarch64-apple-darwin
  script:
    - npm run tauri build -- --target aarch64-apple-darwin
  after_script:
    - mv src-tauri/tauri.conf.json.bak src-tauri/tauri.conf.json || true
  artifacts:
    name: "backstage68-$BUILD_ENV-macos-aarch64-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
    expire_in: 7 days
  only:
    - main
    - master
    - tags
    - web

# macOS æž„å»ºï¼ˆIntelï¼‰
build:macos-x64:
  stage: build
  tags:
    - macos
  <<: *cache_config
  before_script:
    - *determine_env
    - *load_env
    - *update_config
    - brew install node@${NODE_VERSION} || true
    - npm ci
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup target add x86_64-apple-darwin
  script:
    - npm run tauri build -- --target x86_64-apple-darwin
  after_script:
    - mv src-tauri/tauri.conf.json.bak src-tauri/tauri.conf.json || true
  artifacts:
    name: "backstage68-$BUILD_ENV-macos-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app
    expire_in: 7 days
  only:
    - main
    - master
    - tags
    - web

# Windows æž„å»º
build:windows:
  stage: build
  tags:
    - windows
  <<: *cache_config
  before_script:
    - *determine_env
    - *load_env
    - *update_config
    # Windows ä½¿ç”¨ PowerShell
    - choco install nodejs.install --version=$NODE_VERSION -y
    - npm ci
    - choco install rust -y
    - refreshenv
  script:
    - npm run tauri build
  after_script:
    - if (Test-Path "src-tauri/tauri.conf.json.bak") { Move-Item -Force src-tauri/tauri.conf.json.bak src-tauri/tauri.conf.json }
  artifacts:
    name: "backstage68-$BUILD_ENV-windows-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/msi/*.msi
      - src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 7 days
  only:
    - main
    - master
    - tags
    - web

# Linux æž„å»º
build:linux:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker
  <<: *cache_config
  before_script:
    - *determine_env
    - *load_env
    - *update_config
    # å®‰è£…ä¾èµ–
    - apt-get update
    - apt-get install -y curl wget git build-essential
    - apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev
    # å®‰è£… Node.js
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    - npm ci
    # å®‰è£… Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
  script:
    - npm run tauri build
  after_script:
    - mv src-tauri/tauri.conf.json.bak src-tauri/tauri.conf.json || true
  artifacts:
    name: "backstage68-$BUILD_ENV-linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/appimage/*.AppImage
      - src-tauri/target/release/bundle/rpm/*.rpm
    expire_in: 7 days
  only:
    - main
    - master
    - tags
    - web

# åˆ›å»º Releaseï¼ˆä»…åœ¨æ‰“ tag æ—¶ï¼‰
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build:macos-aarch64
    - build:macos-x64
    - build:windows
    - build:linux
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: '$CI_COMMIT_TAG'
    name: 'Backstage68 $CI_COMMIT_TAG'
    description: |
      ðŸš€ **Backstage68 Release $CI_COMMIT_TAG**
      
      æž„å»ºä¿¡æ¯:
      - æäº¤: $CI_COMMIT_SHORT_SHA
      - åˆ†æ”¯: $CI_COMMIT_BRANCH
      - æ—¶é—´: $CI_COMMIT_TIMESTAMP
      
      ## ðŸ“¦ ä¸‹è½½
      
      è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
      
      - **macOS (Apple Silicon)**: `.dmg` (aarch64)
      - **macOS (Intel)**: `.dmg` (x64)
      - **Windows**: `.msi` æˆ– `.exe`
      - **Linux**: `.deb`, `.rpm` æˆ– `.AppImage`
    assets:
      links:
        - name: 'macOS (Apple Silicon)'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/browse?job=build:macos-aarch64'
        - name: 'macOS (Intel)'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/browse?job=build:macos-x64'
        - name: 'Windows'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/browse?job=build:windows'
        - name: 'Linux'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/browse?job=build:linux'
  only:
    - tags

# æ‰‹åŠ¨è§¦å‘æž„å»ºï¼ˆä»»æ„çŽ¯å¢ƒï¼‰
.manual_build:
  extends: .build_template
  when: manual
  variables:
    BUILD_ENV: "test"  # å¯åœ¨ GitLab UI ä¸­ä¿®æ”¹

