name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'æ„å»ºç¯å¢ƒ'
        required: true
        type: choice
        options:
          - test
          - uat
          - prod

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: åŠ è½½ç¯å¢ƒå˜é‡
        shell: bash
        run: |
          ENV=${{ github.event.inputs.environment }}
          if [ -f "env.${ENV}" ]; then
            cat "env.${ENV}" >> $GITHUB_ENV
            echo "âœ“ å·²åŠ è½½ env.${ENV}"
          else
            echo "âŒ ç¯å¢ƒæ–‡ä»¶ env.${ENV} ä¸å­˜åœ¨"
            exit 1
          fi

      - name: æ›´æ–° tauri.conf.json
        shell: bash
        run: |
          jq --arg name "$TAURI_PRODUCT_NAME" --arg id "$TAURI_BUNDLE_IDENTIFIER" \
            '.productName = $name | .identifier = $id' \
            src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp
          mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json

      - name: æ„å»º Tauri åº”ç”¨
        run: npm run tauri build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAURI_PRODUCT_NAME }}-${{ github.event.inputs.environment }}-windows
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe

      - name: æ„å»ºä¿¡æ¯
        shell: bash
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
          echo "äº§å“åç§°: $TAURI_PRODUCT_NAME"
          echo "ç¯å¢ƒ: $TAURI_ENV_NAME ($TAURI_ENV_KEY)"
          echo "URL: $TAURI_ENV_URL"
          echo ""
          echo "MSI å®‰è£…åŒ…:"
          ls -lh src-tauri/target/release/bundle/msi/*.msi 2>/dev/null || echo "  (æœªç”Ÿæˆ)"
          echo ""
          echo "NSIS å®‰è£…åŒ…:"
          ls -lh src-tauri/target/release/bundle/nsis/*.exe 2>/dev/null || echo "  (æœªç”Ÿæˆ)"

