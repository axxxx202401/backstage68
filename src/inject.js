// Backstage68 Inject Script - Generated from modular source
// DO NOT EDIT THIS FILE DIRECTLY - Edit src/inject-refactored.js and run npm run build

(function () {
  'use strict';

  /**
   * æ—¥å¿—å·¥å…·æ¨¡å—
   */

  function initLogger() {
    const ENABLE_LOGS = window.__TAURI_ENABLE_LOGS__ || false;
    
    const log = (...args) => {
      if (ENABLE_LOGS) {
        console.log(...args);
      }
    };
    
    log.info = (...args) => {
      if (ENABLE_LOGS) {
        console.info(...args);
      }
    };
    
    log.warn = (...args) => {
      if (ENABLE_LOGS) {
        console.warn(...args);
      }
    };
    
    log.error = (...args) => {
      console.error(...args); // é”™è¯¯å§‹ç»ˆè¾“å‡º
    };
    
    return log;
  }

  /**
   * DOM å·¥å…·æ¨¡å—
   */

  /**
   * æ£€æŸ¥æ˜¯å¦åœ¨ iframe å†…
   */
  function isInIframe() {
    return window.self !== window.top;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸º Mac
   */
  function isMac() {
    return navigator.platform.toUpperCase().indexOf('MAC') >= 0;
  }

  /**
   * è·å–ä¿®é¥°é”®ï¼ˆMac: metaKey, Windows: ctrlKeyï¼‰
   */
  function getModifierKey(event) {
    return isMac() ? event.metaKey : event.ctrlKey;
  }

  /**
   * HTTP ä»£ç†æ‹¦æˆªæ¨¡å— (Fetch + XMLHttpRequest)
   */

  function initProxy(log, invoke) {
    log("ğŸš€ åˆå§‹åŒ–ä»£ç†æ¨¡å—...");
    
    // --- Override window.fetch ---
    const originalFetch = window.fetch;
    
    window.fetch = async function(input, init) {
      let url = input;
      if (input instanceof Request) {
        url = input.url;
        if (!init) {
          init = {
            method: input.method,
            headers: input.headers,
            body: input.body
          };
        }
      }
      
      if (url.startsWith('/')) {
        url = window.location.origin + url;
      }

      if (url.includes('ipc://localhost') || url.includes('tauri://')) {
        return originalFetch.apply(this, arguments);
      }

      if (!url.includes('/base_api/')) {
        return originalFetch.apply(this, arguments);
      }

      log("ğŸ”„ [Fetch] Intercepted:", url);

      let headers = {};
      if (init && init.headers) {
        if (init.headers instanceof Headers) {
          init.headers.forEach((v, k) => headers[k] = v);
        } else {
          headers = init.headers;
        }
      }

      let body = null;
      let formData = null;
      let files = null;
      
      if (init && init.body) {
        if (typeof init.body === 'string') {
          body = init.body;
        } else if (init.body instanceof FormData) {
          log("ğŸ“¦ æ£€æµ‹åˆ° FormData");
          formData = [];
          files = [];
          
          for (const [key, value] of init.body.entries()) {
            if (value instanceof File) {
              const reader = new FileReader();
              const filePromise = new Promise((resolve) => {
                reader.onload = () => {
                  const base64 = reader.result.split(',')[1];
                  files.push({
                    field_name: key,
                    file_name: value.name,
                    content_type: value.type || 'application/octet-stream',
                    data: base64
                  });
                  resolve();
                };
                reader.onerror = () => resolve();
              });
              reader.readAsDataURL(value);
              await filePromise;
            } else {
              formData.push([key, value.toString()]);
            }
          }
          
          delete headers['Content-Type'];
          delete headers['content-type'];
        } else {
          try {
            body = JSON.stringify(init.body);
          } catch(e) {
            log.warn("Could not stringify body", e);
          }
        }
      }

      const reqData = {
        method: (init && init.method) ? init.method.toUpperCase() : 'GET',
        url: url.toString(),
        headers: headers,
        body: body,
        form_data: formData,
        files: files && files.length > 0 ? files : null
      };

      try {
        const response = await invoke('proxy_request', { request: reqData });
        
        if (response.status === 403) {
          log.error("âš ï¸ 403 Forbidden!");
        }
        
        return new Response(response.body, {
          status: response.status,
          statusText: response.status === 200 ? 'OK' : 'Error',
          headers: new Headers(response.headers)
        });
        
      } catch (err) {
        log.error("âŒ Proxy Request Failed:", err);
        throw err;
      }
    };

    // --- Override XMLHttpRequest ---
    const OriginalXHR = window.XMLHttpRequest;
    
    function ProxyXHR() {
      this.headers = {};
      this.responseHeaders = {};
      this.onreadystatechange = null;
      this.onload = null;
      this.onerror = null;
      this.status = 0;
      this.readyState = 0;
      this.responseText = "";
      this.response = "";
    }

    ProxyXHR.prototype.open = function(method, url, async, user, password) {
      this.method = method;
      this.url = url;
      this.readyState = 1;
      if (this.onreadystatechange) this.onreadystatechange();
    };

    ProxyXHR.prototype.setRequestHeader = function(header, value) {
      this.headers[header] = value;
    };

    ProxyXHR.prototype.send = function(data) {
      let url = this.url;
      if (url.startsWith('/')) {
        url = window.location.origin + url;
      }
      
      if (!url.includes('/base_api/')) {
        const originalXHR = new OriginalXHR();
        originalXHR.open(this.method, this.url, true);
        for (const [key, value] of Object.entries(this.headers)) {
          originalXHR.setRequestHeader(key, value);
        }
        originalXHR.onload = () => {
          this.status = originalXHR.status;
          this.responseText = originalXHR.responseText;
          this.response = originalXHR.response;
          this.readyState = 4;
          if (this.onreadystatechange) this.onreadystatechange();
          if (this.onload) this.onload();
        };
        originalXHR.onerror = (err) => {
          if (this.onerror) this.onerror(err);
        };
        originalXHR.send(data);
        return;
      }
      
      const self = this;
      
      if (data instanceof FormData) {
        (async () => {
          try {
            const formDataArray = [];
            const filesArray = [];
            
            for (const [key, value] of data.entries()) {
              if (value instanceof File) {
                const base64 = await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result.split(',')[1]);
                  reader.onerror = () => reject(reader.error);
                  reader.readAsDataURL(value);
                });
                
                filesArray.push({
                  field_name: key,
                  file_name: value.name,
                  content_type: value.type || 'application/octet-stream',
                  data: base64
                });
              } else {
                formDataArray.push([key, value.toString()]);
              }
            }
            
            const reqData = {
              method: self.method,
              url: url,
              headers: self.headers,
              body: null,
              form_data: formDataArray.length > 0 ? formDataArray : null,
              files: filesArray.length > 0 ? filesArray : null
            };
            
            delete reqData.headers['Content-Type'];
            delete reqData.headers['content-type'];
            
            const response = await invoke('proxy_request', { request: reqData });
            
            self.status = response.status;
            self.statusText = response.status === 200 ? "OK" : "";
            self.responseText = response.body;
            self.response = response.body;
            self.readyState = 4;
            self.responseHeaders = response.headers;
            
            if (self.onreadystatechange) self.onreadystatechange();
            if (self.onload) self.onload();
            
          } catch (err) {
            log.error("XHR FormData Error:", err);
            if (self.onerror) self.onerror(err);
          }
        })();
        return;
      }
      
      const reqData = {
        method: this.method,
        url: url,
        headers: this.headers,
        body: data ? data.toString() : null
      };
      
      invoke('proxy_request', { request: reqData })
        .then(response => {
          self.status = response.status;
          self.statusText = response.status === 200 ? "OK" : "";
          self.responseText = response.body;
          self.response = response.body;
          self.readyState = 4;
          self.responseHeaders = response.headers;

          if (self.onreadystatechange) self.onreadystatechange();
          if (self.onload) self.onload();
        })
        .catch(err => {
          log.error("XHR Proxy Error", err);
          if (self.onerror) self.onerror(err);
        });
    };
    
    ProxyXHR.prototype.getAllResponseHeaders = function() {
      let res = "";
      for (const [k, v] of Object.entries(this.responseHeaders)) {
        res += `${k}: ${v}\r\n`;
      }
      return res;
    };
    
    ProxyXHR.prototype.getResponseHeader = function(name) {
      return this.responseHeaders[name] || null;
    };

    window.XMLHttpRequest = ProxyXHR;
    log("âœ… ä»£ç†æ¨¡å—å·²å¯ç”¨");
  }

  /**
   * é¡µé¢ç¼©æ”¾æ¨¡å—
   */


  const MIN_ZOOM = 0.25;   // 25%
  const MAX_ZOOM = 5.0;    // 500%
  const ZOOM_STEP = 0.05;  // 5%

  function initZoom(log) {
    log("ğŸ” åˆå§‹åŒ–ç¼©æ”¾æ¨¡å—...");
    
    let currentZoom = 1.0;
    let zoomIndicator = null;
    let zoomTimeout = null;

    function createZoomIndicator() {
      if (!zoomIndicator) {
        zoomIndicator = document.createElement('div');
        zoomIndicator.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 24px;
        font-weight: bold;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        z-index: 999999;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      `;
        document.body.appendChild(zoomIndicator);
      }
      return zoomIndicator;
    }

    function showZoomIndicator(zoom) {
      const indicator = createZoomIndicator();
      indicator.textContent = `${Math.round(zoom * 100)}%`;
      indicator.style.opacity = '1';

      if (zoomTimeout) {
        clearTimeout(zoomTimeout);
      }

      zoomTimeout = setTimeout(() => {
        indicator.style.opacity = '0';
      }, 1000);
    }

    async function applyZoom(zoom) {
      try {
        currentZoom = zoom;
        if (window.tauriTabs) {
          window.tauriTabs.currentZoom = zoom;
        }
        showZoomIndicator(zoom);
        
        if (window.self === window.top && window.tauriTabs && window.tauriTabs.activeTabId) {
          const activeTab = window.tauriTabs.tabs.find(t => t.id === window.tauriTabs.activeTabId);
          if (activeTab && activeTab.iframe) {
            try {
              const iframeDoc = activeTab.iframe.contentDocument || activeTab.iframe.contentWindow.document;
              if (iframeDoc && iframeDoc.body) {
                iframeDoc.body.style.zoom = zoom;
                return;
              }
            } catch (e) {
              // Ignore
            }
          }
        }
        
        if (document.body) {
          document.body.style.zoom = zoom;
        }
      } catch (err) {
        log.error("ç¼©æ”¾å¤±è´¥:", err);
      }
    }

    async function zoomIn() {
      const newZoom = Math.min(currentZoom + ZOOM_STEP, MAX_ZOOM);
      await applyZoom(newZoom);
    }

    async function zoomOut() {
      const newZoom = Math.max(currentZoom - ZOOM_STEP, MIN_ZOOM);
      await applyZoom(newZoom);
    }

    async function zoomReset() {
      await applyZoom(1.0);
    }

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', async (e) => {
      const ctrlKey = getModifierKey(e);

      if (ctrlKey && (e.key === '+' || e.key === '=')) {
        e.preventDefault();
        if (window.self !== window.top && window.parent.tauriZoom) {
          await window.parent.tauriZoom.zoomIn();
        } else {
          await zoomIn();
        }
      } else if (ctrlKey && e.key === '-') {
        e.preventDefault();
        if (window.self !== window.top && window.parent.tauriZoom) {
          await window.parent.tauriZoom.zoomOut();
        } else {
          await zoomOut();
        }
      } else if (ctrlKey && e.key === '0') {
        e.preventDefault();
        if (window.self !== window.top && window.parent.tauriZoom) {
          await window.parent.tauriZoom.reset();
        } else {
          await zoomReset();
        }
      }
    });

    // é¼ æ ‡æ»šè½®ç¼©æ”¾
    document.addEventListener('wheel', async (e) => {
      const ctrlKey = getModifierKey(e);

      if (ctrlKey) {
        e.preventDefault();
        
        if (window.self !== window.top && window.parent.tauriZoom) {
          if (e.deltaY < 0) {
            await window.parent.tauriZoom.zoomIn();
          } else {
            await window.parent.tauriZoom.zoomOut();
          }
        } else {
          if (e.deltaY < 0) {
            await zoomIn();
          } else {
            await zoomOut();
          }
        }
      }
    }, { passive: false });

    // æš´éœ²åˆ°å…¨å±€
    window.tauriZoom = {
      zoomIn,
      zoomOut,
      reset: zoomReset,
      get: () => currentZoom,
      set: applyZoom
    };

    log("âœ… ç¼©æ”¾æ¨¡å—å·²å¯ç”¨");
  }

  /**
   * å­˜å‚¨å·¥å…·æ¨¡å—
   */

  /**
   * åºåˆ—åŒ–å­˜å‚¨æ•°æ®ï¼ˆç”¨äºè·¨çª—å£ä¼ é€’ï¼‰
   */
  function serializeStorage() {
    const data = {
      localStorage: {},
      sessionStorage: {}
    };
    
    // å¤åˆ¶ localStorage
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      data.localStorage[key] = localStorage.getItem(key);
    }
    
    // å¤åˆ¶ sessionStorage
    for (let i = 0; i < sessionStorage.length; i++) {
      const key = sessionStorage.key(i);
      data.sessionStorage[key] = sessionStorage.getItem(key);
    }
    
    return data;
  }

  /**
   * å¤šçª—å£æ”¯æŒæ¨¡å—
   */


  function initWindow(log, invoke) {
    log("ğŸªŸ åˆå§‹åŒ–å¤šçª—å£æ¨¡å—...");

    // åˆ›å»ºæ–°çª—å£ï¼ˆæ‰“å¼€å½“å‰é¡µé¢ï¼Œå¹¶å¤åˆ¶ç™»å½•çŠ¶æ€ï¼‰
    window.tauriOpenNewWindow = async function(url) {
      try {
        const targetUrl = url || window.location.href;
        log(`ğŸªŸ å‡†å¤‡æ‰“å¼€æ–°çª—å£: ${targetUrl}`);
        
        const storageData = serializeStorage();
        
        const windowLabel = await invoke('create_new_window', { 
          currentUrl: targetUrl,
          storageData: JSON.stringify(storageData)
        });
        
        log(`âœ… æ–°çª—å£å·²åˆ›å»º: ${windowLabel}`);
        return windowLabel;
      } catch (err) {
        console.error("âŒ åˆ›å»ºçª—å£å¤±è´¥:", err);
        throw err;
      }
    };

    // å¿«æ·é”®ï¼šCmd/Ctrl+Shift+N åˆ›å»ºæ–°çª—å£ï¼ˆæ‰“å¼€å½“å‰é¡µé¢ï¼‰
    document.addEventListener('keydown', (e) => {
      if (getModifierKey(e) && e.shiftKey && e.key === 'n') {
        e.preventDefault();
        e.stopPropagation();
        log('ğŸ”¥ Cmd+Shift+N è§¦å‘ï¼Œæ‰“å¼€æ–°çª—å£');
        window.tauriOpenNewWindow();
      }
    }, true);

    // çª—å£æ ‡é¢˜åŒæ­¥
    initWindowTitleSync(log, invoke);

    log("âœ… å¤šçª—å£æ¨¡å—å·²å¯ç”¨");
  }

  // çª—å£æ ‡é¢˜åŒæ­¥ï¼ˆè·Ÿéšé¡µé¢æ ‡é¢˜å˜åŒ–ï¼‰
  function initWindowTitleSync(log, invoke) {
    let envName = 'Backstage68';
    
    // å¼‚æ­¥è·å–ç¯å¢ƒåç§°
    (async function() {
      try {
        const envInfo = await invoke('get_env_info');
        const match = envInfo.match(/å½“å‰ç¯å¢ƒ: (.+?) \(/);
        if (match) {
          envName = match[1];
          log(`âœ… ç¯å¢ƒåç§°: ${envName}`);
        }
      } catch (err) {
        log('âš ï¸ æ— æ³•è·å–ç¯å¢ƒåç§°ï¼Œä½¿ç”¨é»˜è®¤å€¼');
      }
    })();
    
    // æ›´æ–°çª—å£æ ‡é¢˜çš„å‡½æ•°
    async function updateWindowTitle() {
      try {
        const pageTitle = document.title || 'æœªå‘½åé¡µé¢';
        const newTitle = `${pageTitle} - ${envName}`;
        
        await invoke('set_window_title', { title: newTitle });
        log(`âœ… çª—å£æ ‡é¢˜å·²æ›´æ–°: ${newTitle}`);
      } catch (err) {
        console.error('âŒ æ›´æ–°çª—å£æ ‡é¢˜å¤±è´¥:', err);
      }
    }
    
    // ç›‘å¬ document.title å˜åŒ–
    const titleObserver = new MutationObserver(() => {
      log('ğŸ”” æ£€æµ‹åˆ°æ ‡é¢˜å˜åŒ–:', document.title);
      updateWindowTitle();
    });
    
    const titleElement = document.querySelector('title');
    if (titleElement) {
      titleObserver.observe(titleElement, {
        childList: true,
        subtree: true,
        characterData: true
      });
      log('ğŸ‘€ å¼€å§‹ç›‘å¬é¡µé¢æ ‡é¢˜å˜åŒ–');
    }
    
    // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡æ ‡é¢˜
    if (document.readyState === 'complete') {
      setTimeout(updateWindowTitle, 500);
    } else {
      window.addEventListener('load', () => {
        setTimeout(updateWindowTitle, 500);
      });
    }
    
    // è·¯ç”±å˜åŒ–æ—¶ä¹Ÿæ›´æ–°æ ‡é¢˜ï¼ˆé€‚é… SPAï¼‰
    let lastUrl = window.location.href;
    setInterval(() => {
      const currentUrl = window.location.href;
      if (currentUrl !== lastUrl) {
        lastUrl = currentUrl;
        log('ğŸ”„ è·¯ç”±å˜åŒ–ï¼Œç­‰å¾…æ ‡é¢˜æ›´æ–°...');
        setTimeout(updateWindowTitle, 300);
      }
    }, 500);
  }

  /**
   * æ ‡ç­¾é¡µ UI æ¨¡å—
   */

  const TAB_CONFIG = {
    maxTabs: 20,
    tabBarHeight: 40,
    minTabWidth: 40,
    maxTabWidth: 200,
    defaultTabWidth: 200
  };

  // åˆ›å»ºæ ‡ç­¾æ 
  function createTabBar() {
    const tabBar = document.createElement('div');
    tabBar.id = 'tauri-tab-bar';
    tabBar.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: ${TAB_CONFIG.tabBarHeight}px;
    background: linear-gradient(180deg, #3a3a3a 0%, #2c2c2c 100%);
    display: flex;
    align-items: center;
    padding: 0;
    z-index: 999999;
    user-select: none;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  `;
    
    const tabsContainer = document.createElement('div');
    tabsContainer.className = 'tauri-tabs-container';
    tabsContainer.style.cssText = `
    flex: 1;
    display: flex;
    align-items: center;
    padding: 0 8px;
    overflow: hidden;
    gap: 4px;
  `;
    
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'tauri-tab-controls-fixed';
    controlsContainer.style.cssText = `
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 0 8px;
    flex-shrink: 0;
    background: linear-gradient(90deg, rgba(42, 42, 42, 0.8) 0%, #2c2c2c 20%);
  `;
    
    tabBar.appendChild(tabsContainer);
    tabBar.appendChild(controlsContainer);
    
    createStyles();
    document.body.appendChild(tabBar);
    
    return { tabBar, tabsContainer, controlsContainer };
  }

  // åˆ›å»ºæ ·å¼
  function createStyles() {
    const style = document.createElement('style');
    style.textContent = `
    .tauri-tabs-container::-webkit-scrollbar { display: none; }
    .tauri-tab {
      min-width: ${TAB_CONFIG.minTabWidth}px;
      max-width: ${TAB_CONFIG.maxTabWidth}px;
      width: ${TAB_CONFIG.defaultTabWidth}px;
      height: 30px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px 6px 0 0;
      display: flex;
      align-items: center;
      padding: 0 8px;
      cursor: pointer;
      transition: background 0.2s, width 0.3s ease;
      flex-shrink: 1;
      position: relative;
    }
    .tauri-tab:hover { background: rgba(255,255,255,0.1); }
    .tauri-tab.active {
      background: rgba(255,255,255,0.15);
      box-shadow: 0 -2px 0 0 #0066cc inset;
    }
    .tauri-tab-title {
      flex: 1;
      color: #e0e0e0;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tauri-tab.active .tauri-tab-title { color: #ffffff; }
    .tauri-tab-close {
      margin-left: 8px;
      color: #999;
      font-size: 18px;
      line-height: 1;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .tauri-tab-close:hover {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }
    .tauri-new-tab, .tauri-search-tab {
      min-width: 32px;
      width: 32px;
      height: 30px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      color: #e0e0e0;
      flex-shrink: 0;
    }
    .tauri-new-tab { font-size: 20px; }
    .tauri-search-tab { font-size: 18px; }
    .tauri-new-tab:hover, .tauri-search-tab:hover {
      background: rgba(255,255,255,0.15);
    }
    .tauri-iframe-container {
      position: fixed;
      top: ${TAB_CONFIG.tabBarHeight}px;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: calc(100vh - ${TAB_CONFIG.tabBarHeight}px);
    }
    .tauri-tab-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: none;
    }
    .tauri-tab-iframe.active { display: block; }
    .tauri-tab.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .tauri-tab.drag-over {
      background: rgba(255,255,255,0.25);
      border-left: 2px solid #0066cc;
    }
  `;
    document.head.appendChild(style);
  }

  // æ›´æ–°æ ‡ç­¾å®½åº¦ï¼ˆè‡ªé€‚åº”ï¼‰
  function updateTabWidths() {
    const container = document.querySelector('.tauri-tabs-container');
    if (!container) return;
    
    const newTabBtn = container.querySelector('.tauri-new-tab');
    const tabs = Array.from(container.querySelectorAll('.tauri-tab'));
    
    if (tabs.length === 0) return;
    
    const containerWidth = container.clientWidth;
    const newTabBtnWidth = newTabBtn ? 36 : 0;
    const gap = 4;
    const padding = 16;
    
    const availableWidth = containerWidth - newTabBtnWidth - padding - (gap * tabs.length);
    const idealWidth = availableWidth / tabs.length;
    
    const finalWidth = Math.max(
      TAB_CONFIG.minTabWidth,
      Math.min(TAB_CONFIG.maxTabWidth, idealWidth)
    );
    
    tabs.forEach(tab => {
      tab.style.width = `${finalWidth}px`;
    });
  }

  /**
   * æ ‡ç­¾é¡µæ“ä½œæ¨¡å— - CRUD æ“ä½œ
   */


  // åˆ›å»ºæ ‡ç­¾ DOM å…ƒç´ 
  function createTabElement(id, title, callbacks) {
    const { onClose, onSwitch, onContextMenu, onDragEvents } = callbacks;
    
    const tab = document.createElement('div');
    tab.className = 'tauri-tab';
    tab.dataset.tabId = id;
    tab.setAttribute('draggable', 'true');
    
    const titleSpan = document.createElement('span');
    titleSpan.className = 'tauri-tab-title';
    titleSpan.textContent = title;
    tab.appendChild(titleSpan);
    
    if (TAB_CONFIG.enableCloseButton) {
      const closeBtn = document.createElement('span');
      closeBtn.className = 'tauri-tab-close';
      closeBtn.innerHTML = 'Ã—';
      closeBtn.title = 'å…³é—­æ ‡ç­¾ (Cmd+W)';
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        onClose(id);
      });
      tab.appendChild(closeBtn);
    }
    
    tab.addEventListener('click', () => onSwitch(id));
    tab.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      onContextMenu(id, e.clientX, e.clientY);
    });
    
    // æ‹–åŠ¨äº‹ä»¶
    if (onDragEvents) {
      tab.addEventListener('dragstart', (e) => onDragEvents.dragStart(e, id, tab));
      tab.addEventListener('dragend', (e) => onDragEvents.dragEnd(e, id, tab));
      tab.addEventListener('dragover', (e) => onDragEvents.dragOver(e, tab));
      tab.addEventListener('dragleave', (e) => onDragEvents.dragLeave(e, tab));
      tab.addEventListener('drop', (e) => onDragEvents.drop(e, id, tab));
    }
    
    return tab;
  }

  // åˆ›å»º iframe å®¹å™¨
  function createIframeContainer() {
    const container = document.createElement('div');
    container.className = 'tauri-iframe-container';
    document.body.appendChild(container);
    return container;
  }

  // åˆ›å»º iframe
  function createIframe(url, log) {
    const container = document.querySelector('.tauri-iframe-container') || createIframeContainer();
    
    const iframe = document.createElement('iframe');
    iframe.className = 'tauri-tab-iframe';
    iframe.src = url;
    
    container.appendChild(iframe);
    
    // iframe åŠ è½½å®Œæˆåï¼Œè®¾ç½®ä»£ç†å’Œäº‹ä»¶ç›‘å¬
    iframe.addEventListener('load', () => {
      try {
        const iframeWindow = iframe.contentWindow;
        const iframeDoc = iframe.contentDocument;
        
        if (iframeWindow && iframeDoc && window.self === window.top) {
          // ç”¨çˆ¶çª—å£çš„ä»£ç†æ›¿æ¢ iframe çš„ fetch å’Œ XHR
          iframeWindow.fetch = window.fetch;
          iframeWindow.XMLHttpRequest = window.XMLHttpRequest;
          log(`âœ… iframe å·²ç»§æ‰¿çˆ¶çª—å£çš„ä»£ç†`);
          
          // åœ¨ iframe å†…éƒ¨æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
          setupIframeEvents(iframeDoc, log);
          
          log(`âœ… iframe äº‹ä»¶ç›‘å¬å™¨å·²å®‰è£…`);
        }
      } catch (err) {
        log(`âš ï¸  æ— æ³•è®¾ç½® iframe: ${err.message}`);
      }
    });
    
    return iframe;
  }

  // è®¾ç½® iframe å†…éƒ¨äº‹ä»¶
  function setupIframeEvents(iframeDoc, log) {
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    
    // é”®ç›˜äº‹ä»¶
    iframeDoc.addEventListener('keydown', (e) => {
      const isCtrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
      
      if (!isCtrlOrCmd) return;
      
      // ç¼©æ”¾å¿«æ·é”®
      if (e.key === '+' || e.key === '=') {
        e.preventDefault();
        if (window.tauriZoom && window.tauriZoom.zoomIn) {
          window.tauriZoom.zoomIn();
        }
      } else if (e.key === '-') {
        e.preventDefault();
        if (window.tauriZoom && window.tauriZoom.zoomOut) {
          window.tauriZoom.zoomOut();
        }
      } else if (e.key === '0') {
        e.preventDefault();
        if (window.tauriZoom && window.tauriZoom.reset) {
          window.tauriZoom.reset();
        }
      }
      
      // æ ‡ç­¾é¡µå¿«æ·é”®
      if (window.tauriTabs && window.tauriTabs.tabs) {
        if (e.key === 't') {
          e.preventDefault();
          const activeTab = window.tauriTabs.tabs.find(t => t.id === window.tauriTabs.activeTabId);
          const currentUrl = activeTab ? activeTab.url : window.location.href;
          if (window.tauriTabs.createTab) {
            window.tauriTabs.createTab(currentUrl);
          }
        } else if (e.key === 'w' && window.tauriTabs.tabs.length > 1) {
          e.preventDefault();
          if (window.tauriTabs.activeTabId && window.tauriTabs.closeTab) {
            window.tauriTabs.closeTab(window.tauriTabs.activeTabId);
          }
        } else if (e.key >= '1' && e.key <= '9') {
          e.preventDefault();
          const index = parseInt(e.key) - 1;
          if (index < window.tauriTabs.tabs.length && window.tauriTabs.activateTab) {
            window.tauriTabs.activateTab(window.tauriTabs.tabs[index].id);
          }
        }
      }
    }, true);
    
    // é¼ æ ‡æ»šè½®ç¼©æ”¾
    iframeDoc.addEventListener('wheel', (e) => {
      const isCtrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
      
      if (isCtrlOrCmd) {
        e.preventDefault();
        if (e.deltaY < 0) {
          if (window.tauriZoom && window.tauriZoom.zoomIn) {
            window.tauriZoom.zoomIn();
          }
        } else {
          if (window.tauriZoom && window.tauriZoom.zoomOut) {
            window.tauriZoom.zoomOut();
          }
        }
      }
    }, { passive: false, capture: true });
  }

  // åˆ›å»ºæ–°æ ‡ç­¾
  function createTab(url) {
    const tabs = window.tauriTabs.tabs;
    const log = window.tauriTabs.log;
    
    if (tabs.length >= TAB_CONFIG.maxTabs) {
      alert(`æœ€å¤šåªèƒ½æ‰“å¼€ ${TAB_CONFIG.maxTabs} ä¸ªæ ‡ç­¾`);
      return;
    }
    
    const id = 'tab-' + (++window.tauriTabs.nextId);
    const title = 'åŠ è½½ä¸­...';
    
    log(`ğŸ“‘ åˆ›å»ºæ–°æ ‡ç­¾: ${id}, URL: ${url}`);
    
    const tabElement = createTabElement(id, title, {
      onClose: closeTab,
      onSwitch: activateTab,
      onContextMenu: window.tauriTabs.showContextMenu || (() => {}),
      onDragEvents: window.tauriTabs.dragEvents || null
    });
    
    const iframe = createIframe(url, log);
    
    const tabsContainer = document.querySelector('.tauri-tabs-container');
    const newTabBtn = tabsContainer.querySelector('.tauri-new-tab');
    tabsContainer.insertBefore(tabElement, newTabBtn);
    
    const tabData = {
      id,
      url,
      title,
      element: tabElement,
      iframe
    };
    
    tabs.push(tabData);
    
    // ç›‘å¬ iframe æ ‡é¢˜å˜åŒ–
    setupTitleObserver(iframe, id, tabData, log);
    
    activateTab(id);
    updateTabWidths();
    
    return id;
  }

  // è®¾ç½®æ ‡é¢˜è§‚å¯Ÿå™¨
  function setupTitleObserver(iframe, id, tabData, log) {
    iframe.addEventListener('load', () => {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const newTitle = iframeDoc.title || tabData.url;
        updateTabTitle(id, newTitle);
        
        log(`ğŸ“„ iframe åŠ è½½å®Œæˆï¼Œæ ‡é¢˜: ${newTitle}`);
        
        // ç›‘å¬æ ‡é¢˜å˜åŒ–
        const titleElement = iframeDoc.querySelector('title');
        if (titleElement) {
          const observer = new MutationObserver(() => {
            const updatedTitle = iframeDoc.title;
            if (updatedTitle && updatedTitle !== tabData.title) {
              log(`ğŸ“ æ£€æµ‹åˆ°æ ‡é¢˜å˜åŒ–: ${updatedTitle}`);
              updateTabTitle(id, updatedTitle);
            }
          });
          observer.observe(titleElement, { 
            subtree: true, 
            characterData: true, 
            childList: true 
          });
          tabData.titleObserver = observer;
        }
        
        // å®šæœŸæ£€æŸ¥æ ‡é¢˜ï¼ˆå…œåº•ï¼‰
        const titleCheckInterval = setInterval(() => {
          try {
            const currentTitle = iframeDoc.title;
            if (currentTitle && currentTitle !== tabData.title) {
              log(`ğŸ”„ å®šæœŸæ£€æŸ¥å‘ç°æ ‡é¢˜å˜åŒ–: ${currentTitle}`);
              updateTabTitle(id, currentTitle);
            }
          } catch (err) {
            clearInterval(titleCheckInterval);
          }
        }, 1000);
        tabData.titleCheckInterval = titleCheckInterval;
        
        // åº”ç”¨å½“å‰ç¼©æ”¾
        const zoomLevel = window.tauriTabs.currentZoom || 1.0;
        if (zoomLevel !== 1.0 && iframeDoc.body) {
          iframeDoc.body.style.zoom = zoomLevel;
          log(`ğŸ” åº”ç”¨ç¼©æ”¾ ${Math.round(zoomLevel * 100)}% åˆ°æ–°æ ‡ç­¾`);
        }
      } catch (e) {
        updateTabTitle(id, tabData.url);
        log(`âš ï¸  æ— æ³•è®¿é—® iframe å†…å®¹ (å¯èƒ½è·¨åŸŸ)`);
      }
    });
  }

  // æ¿€æ´»æ ‡ç­¾
  function activateTab(id) {
    const tabs = window.tauriTabs.tabs;
    const tab = tabs.find(t => t.id === id);
    const log = window.tauriTabs.log;
    
    if (!tab) return;
    
    log(`ğŸ”„ åˆ‡æ¢åˆ°æ ‡ç­¾: ${id}`);
    
    tabs.forEach(t => {
      if (t.id === id) {
        t.element.classList.add('active');
        t.iframe.classList.add('active');
      } else {
        t.element.classList.remove('active');
        t.iframe.classList.remove('active');
      }
    });
    
    window.tauriTabs.activeTabId = id;
    
    // æ›´æ–°çª—å£æ ‡é¢˜
    if (tab.title) {
      updateMainWindowTitle(tab.title);
    }
    
    // åº”ç”¨ç¼©æ”¾
    const zoomLevel = window.tauriTabs.currentZoom || 1.0;
    if (zoomLevel !== 1.0) {
      setTimeout(() => {
        try {
          const iframeDoc = tab.iframe.contentDocument || tab.iframe.contentWindow.document;
          if (iframeDoc && iframeDoc.body) {
            iframeDoc.body.style.zoom = zoomLevel;
            log(`ğŸ” åˆ‡æ¢æ ‡ç­¾ååº”ç”¨ç¼©æ”¾: ${Math.round(zoomLevel * 100)}%`);
          }
        } catch (e) {
          log(`âš ï¸  æ— æ³•åº”ç”¨ç¼©æ”¾åˆ° iframe: ${e.message}`);
        }
      }, 100);
    }
  }

  // å…³é—­æ ‡ç­¾
  function closeTab(id) {
    const tabs = window.tauriTabs.tabs;
    const log = window.tauriTabs.log;
    const index = tabs.findIndex(t => t.id === id);
    
    if (index === -1) return;
    
    if (tabs.length === 1) {
      log('âš ï¸  ä¸èƒ½å…³é—­æœ€åä¸€ä¸ªæ ‡ç­¾');
      return;
    }
    
    log(`âŒ å…³é—­æ ‡ç­¾: ${id}`);
    
    const tab = tabs[index];
    
    // æ¸…ç†è§‚å¯Ÿå™¨å’Œå®šæ—¶å™¨
    if (tab.titleObserver) {
      tab.titleObserver.disconnect();
    }
    if (tab.titleCheckInterval) {
      clearInterval(tab.titleCheckInterval);
    }
    
    tab.element.remove();
    tab.iframe.remove();
    tabs.splice(index, 1);
    
    // åˆ‡æ¢åˆ°ç›¸é‚»æ ‡ç­¾
    if (id === window.tauriTabs.activeTabId) {
      const newIndex = Math.min(index, tabs.length - 1);
      activateTab(tabs[newIndex].id);
    }
    
    updateTabWidths();
  }

  // åˆ·æ–°æ ‡ç­¾
  function refreshTab(tabId) {
    const tab = window.tauriTabs.tabs.find(t => t.id === tabId);
    if (!tab) return;
    
    window.tauriTabs.log(`ğŸ”„ åˆ·æ–°æ ‡ç­¾: ${tabId}`);
    tab.iframe.src = tab.iframe.src;
  }

  // å¤åˆ¶æ ‡ç­¾
  function duplicateTab(tabId) {
    const tab = window.tauriTabs.tabs.find(t => t.id === tabId);
    const tabs = window.tauriTabs.tabs;
    const log = window.tauriTabs.log;
    
    if (!tab) return;
    
    if (tabs.length >= TAB_CONFIG.maxTabs) {
      alert(`æœ€å¤šåªèƒ½æ‰“å¼€ ${TAB_CONFIG.maxTabs} ä¸ªæ ‡ç­¾`);
      return;
    }
    
    log(`ğŸ“‹ å¤åˆ¶æ ‡ç­¾: ${tabId}, URL: ${tab.url}`);
    
    let currentUrl = tab.url;
    try {
      const iframeWindow = tab.iframe.contentWindow;
      if (iframeWindow && iframeWindow.location && iframeWindow.location.href) {
        currentUrl = iframeWindow.location.href;
        log(`   ä½¿ç”¨ iframe å½“å‰ URL: ${currentUrl}`);
      }
    } catch (err) {
      log(`   æ— æ³•è·å– iframe å½“å‰ URLï¼Œä½¿ç”¨åŸå§‹ URL: ${tab.url}`);
    }
    
    createTab(currentUrl);
  }

  // åœ¨æ–°çª—å£æ‰“å¼€æ ‡ç­¾
  async function openTabInNewWindow(tabId) {
    const tab = window.tauriTabs.tabs.find(t => t.id === tabId);
    const log = window.tauriTabs.log;
    const invoke = window.tauriTabs.invoke;
    
    if (!tab) return;
    
    log(`ğŸªŸ åœ¨æ–°çª—å£æ‰“å¼€: ${tab.url}`);
    try {
      await invoke('create_new_window', { 
        currentUrl: tab.url,
        storageData: null
      });
    } catch (err) {
      console.error('Failed to open new window:', err);
    }
  }

  // å…³é—­å·¦ä¾§æ ‡ç­¾
  function closeTabsToLeft(tabId) {
    const tabs = window.tauriTabs.tabs;
    const log = window.tauriTabs.log;
    const index = tabs.findIndex(t => t.id === tabId);
    
    if (index <= 0) return;
    
    log(`â¬…ï¸ å…³é—­å·¦ä¾§ ${index} ä¸ªæ ‡ç­¾`);
    
    for (let i = index - 1; i >= 0; i--) {
      closeTab(tabs[i].id);
    }
  }

  // å…³é—­å³ä¾§æ ‡ç­¾
  function closeTabsToRight(tabId) {
    const tabs = window.tauriTabs.tabs;
    const log = window.tauriTabs.log;
    const index = tabs.findIndex(t => t.id === tabId);
    
    if (index === -1 || index === tabs.length - 1) return;
    
    const count = tabs.length - index - 1;
    log(`â¡ï¸ å…³é—­å³ä¾§ ${count} ä¸ªæ ‡ç­¾`);
    
    for (let i = tabs.length - 1; i > index; i--) {
      closeTab(tabs[i].id);
    }
  }

  // å…³é—­å…¶ä»–æ ‡ç­¾
  function closeOtherTabs(tabId) {
    const tabs = window.tauriTabs.tabs;
    const log = window.tauriTabs.log;
    const tabsToClose = tabs.filter(t => t.id !== tabId);
    
    log(`ğŸ—‘ï¸ å…³é—­å…¶ä»– ${tabsToClose.length} ä¸ªæ ‡ç­¾`);
    
    tabsToClose.forEach(tab => closeTab(tab.id));
  }

  // é‡æ–°æ’åºæ ‡ç­¾
  function reorderTabs(draggedId, targetId) {
    const tabs = window.tauriTabs.tabs;
    const log = window.tauriTabs.log;
    const draggedIndex = tabs.findIndex(t => t.id === draggedId);
    const targetIndex = tabs.findIndex(t => t.id === targetId);
    
    if (draggedIndex === -1 || targetIndex === -1 || draggedIndex === targetIndex) return;
    
    log(`ğŸ”„ æ ‡ç­¾é‡æ–°æ’åº: ${draggedId} (ç´¢å¼• ${draggedIndex}) ç§»åŠ¨åˆ° ${targetId} (ç´¢å¼• ${targetIndex})`);
    
    // ç§»åŠ¨æ•°ç»„ä¸­çš„ä½ç½®
    const [draggedTab] = tabs.splice(draggedIndex, 1);
    tabs.splice(targetIndex, 0, draggedTab);
    
    // æ›´æ–° DOM
    const tabsContainer = document.querySelector('.tauri-tabs-container');
    const newTabBtn = tabsContainer.querySelector('.tauri-new-tab');
    
    // æ¸…ç©ºæ ‡ç­¾å®¹å™¨ï¼ˆä¿ç•™æ–°å»ºæŒ‰é’®ï¼‰
    Array.from(tabsContainer.children).forEach(child => {
      if (!child.classList.contains('tauri-new-tab')) {
        child.remove();
      }
    });
    
    // æŒ‰æ–°é¡ºåºæ·»åŠ æ ‡ç­¾
    tabs.forEach(tab => {
      tabsContainer.insertBefore(tab.element, newTabBtn);
    });
    
    updateTabWidths();
    log(`âœ… æ ‡ç­¾é‡æ–°æ’åºå®Œæˆ`);
  }

  // æ›´æ–°æ ‡ç­¾æ ‡é¢˜
  function updateTabTitle(id, title) {
    const tab = window.tauriTabs.tabs.find(t => t.id === id);
    const log = window.tauriTabs.log;
    
    if (!tab) {
      log(`âš ï¸  updateTabTitle: æ‰¾ä¸åˆ°æ ‡ç­¾ ${id}`);
      return;
    }
    
    if (tab.title === title) return;
    
    tab.title = title;
    const titleSpan = tab.element.querySelector('.tauri-tab-title');
    if (titleSpan) {
      titleSpan.textContent = title;
      titleSpan.title = title;
      log(`âœ… æ ‡ç­¾æ ‡é¢˜å·²æ›´æ–°: ${id} -> ${title}`);
    } else {
      log(`âš ï¸  æ‰¾ä¸åˆ°æ ‡é¢˜å…ƒç´ : ${id}`);
    }
    
    if (id === window.tauriTabs.activeTabId) {
      updateMainWindowTitle(title);
    }
  }

  // æ›´æ–°ä¸»çª—å£æ ‡é¢˜
  async function updateMainWindowTitle(title) {
    try {
      const invoke = window.tauriTabs.invoke;
      await invoke('set_window_title', { title: `${title} - ${window.tauriTabs.envName || 'Backstage68'}` });
    } catch (err) {
      console.error('Failed to update window title:', err);
    }
  }

  /**
   * æ ‡ç­¾é¡µäº‹ä»¶æ¨¡å— - é”®ç›˜å¿«æ·é”®ã€æ‹–æ‹½ã€å³é”®èœå•
   */


  // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
  function initTabEvents() {
    setupKeyboardShortcuts();
    setupDragEvents();
    window.tauriTabs.showContextMenu = showTabContextMenu;
  }

  // é”®ç›˜å¿«æ·é”®
  function setupKeyboardShortcuts() {
    if (window.self !== window.top) return;
    
    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const isCtrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
      
      if (!isCtrlOrCmd) return;
      if (!window.tauriTabs || !window.tauriTabs.tabs) return;
      
      // Cmd+T: æ–°å»ºæ ‡ç­¾
      if (e.key === 't') {
        e.preventDefault();
        e.stopPropagation();
        const activeTab = window.tauriTabs.tabs.find(t => t.id === window.tauriTabs.activeTabId);
        const currentUrl = activeTab ? activeTab.url : window.location.href;
        createTab(currentUrl);
      }
      
      // Cmd+W: å…³é—­å½“å‰æ ‡ç­¾
      else if (e.key === 'w') {
        if (window.tauriTabs.tabs.length > 1 && window.tauriTabs.activeTabId) {
          e.preventDefault();
          e.stopPropagation();
          closeTab(window.tauriTabs.activeTabId);
        }
      }
      
      // Cmd+Shift+N: æ–°çª—å£
      else if (e.key === 'N' && e.shiftKey) {
        e.preventDefault();
        e.stopPropagation();
        const activeTab = window.tauriTabs.tabs.find(t => t.id === window.tauriTabs.activeTabId);
        const currentUrl = activeTab ? activeTab.url : window.location.href;
        if (window.tauriOpenNewWindow) {
          window.tauriOpenNewWindow(currentUrl);
        }
      }
      
      // Cmd+Shift+A: æœç´¢æ ‡ç­¾
      else if (e.key === 'A' && e.shiftKey) {
        e.preventDefault();
        e.stopPropagation();
        if (window.tauriTabs.showSearch) {
          window.tauriTabs.showSearch();
        }
      }
      
      // Cmd+æ•°å­—é”®: å¿«é€Ÿåˆ‡æ¢æ ‡ç­¾ (1-9)
      else if (e.key >= '1' && e.key <= '9') {
        e.preventDefault();
        e.stopPropagation();
        const index = parseInt(e.key) - 1;
        const tabs = window.tauriTabs.tabs;
        if (index < tabs.length) {
          activateTab(tabs[index].id);
        }
      }
    }, true);
  }

  // æ‹–æ‹½äº‹ä»¶
  function setupDragEvents() {
    const log = window.tauriTabs.log;
    
    window.tauriTabs.dragEvents = {
      dragStart: (e, id, tab) => {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', id);
        tab.style.opacity = '0.5';
        tab.classList.add('dragging');
        log(`ğŸ–±ï¸ å¼€å§‹æ‹–åŠ¨æ ‡ç­¾: ${id}`);
      },
      
      dragEnd: (e, id, tab) => {
        tab.style.opacity = '1';
        tab.classList.remove('dragging');
        document.querySelectorAll('.tauri-tab.drag-over').forEach(t => {
          t.classList.remove('drag-over');
        });
        log(`ğŸ–±ï¸ ç»“æŸæ‹–åŠ¨æ ‡ç­¾: ${id}`);
      },
      
      dragOver: (e, tab) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (!tab.classList.contains('dragging')) {
          tab.classList.add('drag-over');
        }
      },
      
      dragLeave: (e, tab) => {
        tab.classList.remove('drag-over');
      },
      
      drop: (e, id, tab) => {
        e.preventDefault();
        e.stopPropagation();
        tab.classList.remove('drag-over');
        
        const draggedId = e.dataTransfer.getData('text/plain');
        if (draggedId && draggedId !== id) {
          log(`ğŸ“ æ”¾ç½®æ ‡ç­¾: ${draggedId} -> ${id}`);
          reorderTabs(draggedId, id);
        }
      }
    };
  }

  // æ˜¾ç¤ºå³é”®èœå•
  function showTabContextMenu(tabId, x, y) {
    // ç§»é™¤æ—§èœå•
    const oldMenu = document.querySelector('.tauri-tab-context-menu');
    if (oldMenu) oldMenu.remove();
    
    const menu = document.createElement('div');
    menu.className = 'tauri-tab-context-menu';
    menu.style.cssText = `
    position: fixed;
    left: ${x}px;
    top: ${y}px;
    background: rgba(30, 30, 30, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    padding: 6px;
    z-index: 9999999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 13px;
    min-width: 180px;
    color: white;
  `;
    
    const menuItems = [
      { text: 'ğŸ”„ åˆ·æ–°', action: () => refreshTab(tabId) },
      { text: 'ğŸ“‹ å¤åˆ¶æ ‡ç­¾', action: () => duplicateTab(tabId) },
      { text: 'ğŸªŸ åœ¨æ–°çª—å£æ‰“å¼€', action: () => openTabInNewWindow(tabId) },
      { divider: true },
      { text: 'âŒ å…³é—­', action: () => closeTab(tabId) },
      { text: 'â¬…ï¸ å…³é—­å·¦ä¾§æ ‡ç­¾', action: () => closeTabsToLeft(tabId) },
      { text: 'â¡ï¸ å…³é—­å³ä¾§æ ‡ç­¾', action: () => closeTabsToRight(tabId) },
      { text: 'ğŸ—‘ï¸ å…³é—­å…¶ä»–æ ‡ç­¾', action: () => closeOtherTabs(tabId) }
    ];
    
    menuItems.forEach(item => {
      if (item.divider) {
        const divider = document.createElement('div');
        divider.style.cssText = `
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 4px 0;
      `;
        menu.appendChild(divider);
      } else {
        const menuItem = document.createElement('div');
        menuItem.textContent = item.text;
        menuItem.style.cssText = `
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.15s;
      `;
        menuItem.addEventListener('mouseenter', () => {
          menuItem.style.background = 'rgba(255, 255, 255, 0.1)';
        });
        menuItem.addEventListener('mouseleave', () => {
          menuItem.style.background = 'transparent';
        });
        menuItem.addEventListener('click', () => {
          item.action();
          menu.remove();
        });
        menu.appendChild(menuItem);
      }
    });
    
    document.body.appendChild(menu);
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    setTimeout(() => {
      const closeMenu = (e) => {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', closeMenu, true);
          document.removeEventListener('contextmenu', closeMenu, true);
          
          // ç§»é™¤æ‰€æœ‰ iframe çš„ç›‘å¬å™¨
          window.tauriTabs.tabs.forEach(tab => {
            try {
              const iframeDoc = tab.iframe.contentDocument;
              if (iframeDoc) {
                iframeDoc.removeEventListener('click', closeMenu, true);
                iframeDoc.removeEventListener('contextmenu', closeMenu, true);
              }
            } catch (err) {
              // å¿½ç•¥è·¨åŸŸé”™è¯¯
            }
          });
        }
      };
      
      document.addEventListener('click', closeMenu, true);
      document.addEventListener('contextmenu', closeMenu, true);
      
      // åœ¨æ‰€æœ‰ iframe æ·»åŠ ç›‘å¬å™¨
      window.tauriTabs.tabs.forEach(tab => {
        try {
          const iframeDoc = tab.iframe.contentDocument;
          if (iframeDoc) {
            iframeDoc.addEventListener('click', closeMenu, true);
            iframeDoc.addEventListener('contextmenu', closeMenu, true);
          }
        } catch (err) {
          // å¿½ç•¥è·¨åŸŸé”™è¯¯
        }
      });
    }, 100);
  }

  // æ·»åŠ ä¸Šä¸‹æ–‡èœå•æ ·å¼
  const contextMenuStyle = document.createElement('style');
  contextMenuStyle.textContent = `
  .tauri-tab-context-menu {
    animation: menuFadeIn 0.15s ease-out;
  }
  @keyframes menuFadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
  document.head.appendChild(contextMenuStyle);

  /**
   * æ ‡ç­¾é¡µæœç´¢æ¨¡å—
   */


  // æ˜¾ç¤ºæ ‡ç­¾æœç´¢å¯¹è¯æ¡†
  function showTabSearch() {
    const log = window.tauriTabs.log;
    log('ğŸ” æ‰“å¼€æ ‡ç­¾æœç´¢');
    
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.className = 'tauri-tab-search-overlay';
    
    // åˆ›å»ºå¯¹è¯æ¡†
    const dialog = document.createElement('div');
    dialog.className = 'tauri-tab-search-dialog';
    
    // æœç´¢è¾“å…¥æ¡†
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'tauri-tab-search-input';
    input.placeholder = 'æœç´¢æ ‡ç­¾æ ‡é¢˜';
    
    // ç»“æœå®¹å™¨
    const results = document.createElement('div');
    results.className = 'tauri-tab-search-results';
    
    dialog.appendChild(input);
    dialog.appendChild(results);
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    let selectedIndex = 0;
    
    // æ¸²æŸ“æœç´¢ç»“æœ
    function renderResults(query = '') {
      const tabs = window.tauriTabs.tabs;
      const filtered = query.trim() === '' ? tabs : tabs.filter(tab => {
        const title = (tab.title || '').toLowerCase();
        const q = query.toLowerCase();
        return title.includes(q); // åªæœç´¢æ ‡é¢˜
      });
      
      results.innerHTML = '';
      
      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'tauri-tab-search-empty';
        empty.textContent = 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾';
        results.appendChild(empty);
        return;
      }
      
      filtered.forEach((tab, index) => {
        const item = document.createElement('div');
        item.className = 'tauri-tab-search-item';
        if (index === selectedIndex) {
          item.classList.add('selected');
        }
        
        const icon = document.createElement('div');
        icon.className = 'tauri-tab-search-item-icon';
        icon.textContent = 'ğŸ“„';
        
        const content = document.createElement('div');
        content.className = 'tauri-tab-search-item-content';
        
        const titleEl = document.createElement('div');
        titleEl.className = 'tauri-tab-search-item-title';
        titleEl.textContent = tab.title || 'Untitled';
        
        content.appendChild(titleEl);
        item.appendChild(icon);
        item.appendChild(content);
        
        item.addEventListener('click', () => {
          activateTab(tab.id);
          closeSearch();
        });
        
        results.appendChild(item);
      });
      
      selectedIndex = Math.min(selectedIndex, filtered.length - 1);
    }
    
    // å…³é—­æœç´¢
    function closeSearch() {
      overlay.remove();
      log('ğŸ” å…³é—­æ ‡ç­¾æœç´¢');
    }
    
    // è¾“å…¥äº‹ä»¶
    input.addEventListener('input', () => {
      selectedIndex = 0;
      renderResults(input.value);
    });
    
    // é”®ç›˜äº‹ä»¶
    input.addEventListener('keydown', (e) => {
      const items = results.querySelectorAll('.tauri-tab-search-item');
      
      if (e.key === 'Escape') {
        e.preventDefault();
        closeSearch();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        renderResults(input.value);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        renderResults(input.value);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (items[selectedIndex]) {
          items[selectedIndex].click();
        }
      }
    });
    
    // ç‚¹å‡»é®ç½©å…³é—­
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        closeSearch();
      }
    });
    
    // åˆå§‹æ¸²æŸ“
    renderResults();
    
    // è‡ªåŠ¨èšç„¦
    setTimeout(() => input.focus(), 100);
  }

  // æ·»åŠ æœç´¢æ ·å¼
  const searchStyle = document.createElement('style');
  searchStyle.textContent = `
  .tauri-tab-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 10000000;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 100px;
    animation: overlayFadeIn 0.2s ease-out;
  }
  @keyframes overlayFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .tauri-tab-search-dialog {
    background: #2c2c2c;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.8);
    border: 1px solid #444;
    width: 600px;
    max-width: 90vw;
    max-height: 500px;
    display: flex;
    flex-direction: column;
    animation: dialogSlideIn 0.3s ease-out;
    overflow: hidden;
  }
  @keyframes dialogSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .tauri-tab-search-input {
    width: 100%;
    padding: 16px 20px;
    background: #1e1e1e;
    border: none;
    border-bottom: 1px solid #444;
    color: #e0e0e0;
    font-size: 16px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    outline: none;
    border-radius: 12px 12px 0 0;
    box-sizing: border-box;
  }
  .tauri-tab-search-input:focus {
    background: #252525;
    border-bottom-color: #0066cc;
  }
  .tauri-tab-search-input::placeholder {
    color: #888;
  }
  .tauri-tab-search-results {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
    min-height: 100px;
  }
  .tauri-tab-search-results::-webkit-scrollbar {
    width: 8px;
  }
  .tauri-tab-search-results::-webkit-scrollbar-track {
    background: #2c2c2c;
  }
  .tauri-tab-search-results::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
  }
  .tauri-tab-search-results::-webkit-scrollbar-thumb:hover {
    background: #666;
  }
  .tauri-tab-search-item {
    padding: 12px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.15s;
  }
  .tauri-tab-search-item:hover {
    background: rgba(255,255,255,0.1);
  }
  .tauri-tab-search-item.selected {
    background: rgba(0,102,204,0.3);
  }
  .tauri-tab-search-item-icon {
    font-size: 20px;
    flex-shrink: 0;
  }
  .tauri-tab-search-item-content {
    flex: 1;
    min-width: 0;
  }
  .tauri-tab-search-item-title {
    color: #e0e0e0;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .tauri-tab-search-empty {
    padding: 40px 20px;
    text-align: center;
    color: #888;
    font-size: 14px;
  }
`;
  document.head.appendChild(searchStyle);

  /**
   * æ ‡ç­¾é¡µç®¡ç†æ¨¡å—
   */


  function initTabs(log, invoke) {
    // æ£€æŸ¥æ˜¯å¦åœ¨ iframe å†…éƒ¨
    if (window.self !== window.top) {
      log("âš ï¸  åœ¨ iframe å†…ï¼Œè·³è¿‡æ ‡ç­¾é¡µåˆå§‹åŒ–");
      return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
    if (window.__TAURI_TABS_INITIALIZED__) {
      log("âš ï¸  æ ‡ç­¾é¡µç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œè·³è¿‡");
      return;
    }
    
    // ç­‰å¾… DOM åŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => initTabs(log, invoke));
      return;
    }
    
    log("ğŸ·ï¸ åˆå§‹åŒ–æ ‡ç­¾é¡µæ¨¡å—...");
    
    // æ ‡è®°å·²åˆå§‹åŒ–
    window.__TAURI_TABS_INITIALIZED__ = true;
    
    // è·å–ç¯å¢ƒåç§°
    let envName = 'Backstage68';
    (async function() {
      try {
        const envInfo = await invoke('get_env_info');
        const match = envInfo.match(/å½“å‰ç¯å¢ƒ: (.+?) \(/);
        if (match) {
          envName = match[1];
        }
      } catch (err) {
        // ä½¿ç”¨é»˜è®¤å€¼
      }
    })();

    // åˆ›å»ºæ ‡ç­¾ç®¡ç†å™¨
    window.tauriTabs = {
      tabs: [],
      activeTabId: null,
      nextId: 0,
      currentZoom: 1.0,
      envName,
      log,
      invoke
    };

    // åˆ›å»ºæ ‡ç­¾æ 
    const { tabsContainer, controlsContainer } = createTabBar();
    
    // æ·»åŠ æ–°å»ºæŒ‰é’®
    const newTabBtn = document.createElement('div');
    newTabBtn.className = 'tauri-new-tab';
    newTabBtn.innerHTML = '+';
    newTabBtn.title = 'æ–°å»ºæ ‡ç­¾ (Cmd+T)';
    newTabBtn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      const activeTab = window.tauriTabs.tabs.find(t => t.id === window.tauriTabs.activeTabId);
      const currentUrl = activeTab ? activeTab.url : window.location.href;
      createTab(currentUrl);
    };
    tabsContainer.appendChild(newTabBtn);
    
    // æ·»åŠ æœç´¢æŒ‰é’®
    const searchBtn = document.createElement('div');
    searchBtn.className = 'tauri-search-tab';
    searchBtn.innerHTML = 'ğŸ”';
    searchBtn.title = 'æœç´¢æ ‡ç­¾ (Cmd+Shift+A)';
    searchBtn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      showTabSearch();
    };
    controlsContainer.appendChild(searchBtn);

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    initTabEvents();

    // åˆ›å»ºé¦–ä¸ªæ ‡ç­¾
    const initialUrl = window.location.href;
    createTab(initialUrl);
    
    // éšè—åŸå§‹ body å†…å®¹
    Array.from(document.body.children).forEach(child => {
      if (child.id !== 'tauri-tab-bar' && 
          !child.classList.contains('tauri-iframe-container') &&
          !child.id?.includes('zoom')) {
        child.style.display = 'none';
      }
    });

    // çª—å£å¤§å°å˜åŒ–æ—¶æ›´æ–°æ ‡ç­¾å®½åº¦
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        updateTabWidths();
        log('ğŸ”„ çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è®¡ç®—æ ‡ç­¾å®½åº¦');
      }, 200);
    });

    // æš´éœ² API
    window.tauriTabs.createTab = createTab;
    window.tauriTabs.closeTab = closeTab;
    window.tauriTabs.activateTab = activateTab;
    window.tauriTabs.duplicateTab = duplicateTab;
    window.tauriTabs.reorderTabs = reorderTabs;
    window.tauriTabs.showSearch = showTabSearch;
    window.tauriTabs.updateTabWidths = updateTabWidths;

    log("âœ… æ ‡ç­¾é¡µæ¨¡å—å·²å¯ç”¨");
    console.log("ğŸ‰ æ ‡ç­¾é¡µåŠŸèƒ½å·²å¯ç”¨:");
    console.log("  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("  â•‘  å¿«æ·é”®                            â•‘");
    console.log("  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    console.log("  â•‘  Cmd+T          æ–°å»ºæ ‡ç­¾           â•‘");
    console.log("  â•‘  Cmd+W          å…³é—­å½“å‰æ ‡ç­¾       â•‘");
    console.log("  â•‘  Cmd+Shift+A    æœç´¢æ ‡ç­¾           â•‘");
    console.log("  â•‘  Cmd+Shift+N    æ–°çª—å£ï¼ˆå¤šçª—å£ï¼‰   â•‘");
    console.log("  â•‘  Cmd+1~9        åˆ‡æ¢åˆ°ç¬¬ N ä¸ªæ ‡ç­¾  â•‘");
    console.log("  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    console.log("  â•‘  é¼ æ ‡æ“ä½œ                          â•‘");
    console.log("  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    console.log("  â•‘  æ‹–åŠ¨æ ‡ç­¾        é‡æ–°æ’åº          â•‘");
    console.log("  â•‘  å³é”®æ ‡ç­¾        æ˜¾ç¤ºèœå•          â•‘");
    console.log("  â•‘  ç‚¹å‡» ğŸ”        æœç´¢æ ‡ç­¾           â•‘");
    console.log("  â•‘  ç‚¹å‡» +          æ–°å»ºæ ‡ç­¾          â•‘");
    console.log("  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    console.log(`  æœ€å¤šæ”¯æŒ ${TAB_CONFIG.maxTabs} ä¸ªæ ‡ç­¾ï¼ŒåŠ¨æ€å®½åº¦ï¼Œæ‹–åŠ¨æ’åºï¼Œæœç´¢åŠŸèƒ½`);
  }

  /**
   * Tauri æ³¨å…¥è„šæœ¬ - é‡æ„ç‰ˆæœ¬
   * 
   * æ¨¡å—åŒ–æ¶æ„ï¼š
   * â”œâ”€â”€ logger.js - æ—¥å¿—å·¥å…·
   * â”œâ”€â”€ utils/
   * â”‚   â”œâ”€â”€ dom.js - DOM å·¥å…·å‡½æ•°
   * â”‚   â””â”€â”€ storage.js - å­˜å‚¨å·¥å…·
   * â”œâ”€â”€ proxy.js - HTTP ä»£ç†æ‹¦æˆª (Fetch + XMLHttpRequest)
   * â”œâ”€â”€ zoom.js - é¡µé¢ç¼©æ”¾æ§åˆ¶
   * â”œâ”€â”€ window.js - å¤šçª—å£æ”¯æŒå’Œæ ‡é¢˜åŒæ­¥
   * â””â”€â”€ tabs/
   *     â”œâ”€â”€ manager.js - æ ‡ç­¾é¡µç®¡ç†å™¨ï¼ˆä¸»å…¥å£ï¼‰
   *     â”œâ”€â”€ ui.js - æ ‡ç­¾æ  UI å’Œæ ·å¼
   *     â”œâ”€â”€ operations.js - æ ‡ç­¾ CRUD æ“ä½œ
   *     â”œâ”€â”€ events.js - é”®ç›˜å¿«æ·é”®å’Œæ‹–æ‹½
   *     â””â”€â”€ search.js - æ ‡ç­¾æœç´¢åŠŸèƒ½
   * 
   * ä» 2089 è¡Œå•æ–‡ä»¶é‡æ„ä¸º 11 ä¸ªæ¨¡å—ï¼Œå¹³å‡æ¯ä¸ªæ¨¡å— ~170 è¡Œ
   */


  (function() {
    const log = initLogger();
    log("ğŸš€ Tauri æ³¨å…¥è„šæœ¬å¯åŠ¨ï¼ˆé‡æ„ç‰ˆï¼‰");

    // æ£€æŸ¥æ˜¯å¦åœ¨ iframe å†…
    if (isInIframe()) {
      log("âš ï¸  æ£€æµ‹åˆ°åœ¨ iframe å†…ï¼Œè·³è¿‡åˆå§‹åŒ–");
      return;
    }

    // æ£€æŸ¥ Tauri API
    if (!window.__TAURI__ || !window.__TAURI__.core || !window.__TAURI__.core.invoke) {
      console.error("âŒ Tauri API ä¸å¯ç”¨ï¼ä»£ç†å°†æ— æ³•å·¥ä½œ");
      return;
    }

    const invoke = window.__TAURI__.core.invoke;
    log("âœ… Tauri API å‡†å¤‡å°±ç»ª");

    // åˆå§‹åŒ–å„æ¨¡å—
    try {
      // 1. ä»£ç†æ‹¦æˆªï¼ˆæ‹¦æˆªæ‰€æœ‰ /base_api/ è¯·æ±‚ï¼Œæ·»åŠ å®‰å…¨å¤´ï¼‰
      initProxy(log, invoke);

      // 2. é¡µé¢ç¼©æ”¾ï¼ˆCmd +/-/0ï¼Œæ»šè½®ç¼©æ”¾ï¼‰
      initZoom(log);

      // 3. å¤šçª—å£æ”¯æŒï¼ˆCmd+Shift+Nï¼Œå…±äº«ç™»å½•çŠ¶æ€ï¼‰
      initWindow(log, invoke);

      // 4. æ ‡ç­¾é¡µç³»ç»Ÿï¼ˆæµè§ˆå™¨é£æ ¼æ ‡ç­¾é¡µï¼Œæ”¯æŒ 20 ä¸ªæ ‡ç­¾ï¼‰
      initTabs(log, invoke);

      log("ğŸ‰ æ‰€æœ‰æ¨¡å—åˆå§‹åŒ–å®Œæˆ");
    } catch (err) {
      console.error("âŒ æ¨¡å—åˆå§‹åŒ–å¤±è´¥:", err);
    }
  })();

})();
//# sourceMappingURL=inject.js.map
