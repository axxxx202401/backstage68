# ç®€åŒ–ç‰ˆ GitLab CI - ä»… Linux Docker æž„å»º

stages:
  - build

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo

build:
  stage: build
  image: ubuntu:22.04
  cache:
    key:
      files:
        - package-lock.json
        - src-tauri/Cargo.lock
    paths:
      - .cargo/
      - node_modules/
      - src-tauri/target/
  before_script:
    # åˆ¤æ–­çŽ¯å¢ƒ
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        ENV="prod"
      elif [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "master" ]; then
        ENV="uat"
      else
        ENV="test"
      fi
      echo "ðŸŒ Building for environment: $ENV"
    
    # å®‰è£…ç³»ç»Ÿä¾èµ–
    - apt-get update
    - apt-get install -y curl wget git build-essential jq
    - apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev
    
    # å®‰è£… Node.js
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    - npm ci
    
    # å®‰è£… Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    
    # åŠ è½½çŽ¯å¢ƒå˜é‡
    - set -a
    - source ".env.$ENV"
    - set +a
    
    # æ›´æ–°é…ç½®
    - cp src-tauri/tauri.conf.json src-tauri/tauri.conf.json.bak
    - jq --arg name "$TAURI_PRODUCT_NAME" --arg id "$TAURI_BUNDLE_IDENTIFIER" '.productName = $name | .identifier = $id' src-tauri/tauri.conf.json.bak > src-tauri/tauri.conf.json
  
  script:
    - npm run tauri build
  
  after_script:
    - mv src-tauri/tauri.conf.json.bak src-tauri/tauri.conf.json || true
  
  artifacts:
    name: "backstage68-$ENV-linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 7 days

