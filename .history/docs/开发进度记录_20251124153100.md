# 开发进度记录

## 项目信息
- **项目名称**: Tauri HTTP Wrapper (Custom Auth)
- **目标**: 使用 Tauri 2.0 封装 `http://test-otc.68chat.co/`，并拦截所有 API 请求添加自定义验证头，防止直接浏览器访问。
- **启动时间**: 2025-11-24

## 开发日志

### 2025-11-24: 项目初始化与方案设计
- [x] 创建项目目录结构
- [x] 初始化 Tauri 2.0 配置 (`tauri.conf.json`)
- [x] 实现 JS 注入脚本 (拦截 Fetch/XHR)
- [x] 实现 Rust 后端代理逻辑 (Reqwest + 加密/Header)
- [x] 配置权限 (Capabilities)
- [x] 修复 build.rs 编译错误
- [x] 创建占位图标文件并解决图标加载问题
- [x] 验证 Tauri 项目编译与运行成功
- [x] 实现设备指纹功能（UUID + 硬件哈希）
- [x] 实现 RSA 非对称加密验证（公钥加密，私钥解密）
- [x] 设计并生成应用图标（章鱼 + 盾牌安全主题）
- [x] 优化图标为圆形无白边设计
- [x] 修复 JS 注入时机问题（先注入脚本，后加载 URL）

### 技术验证结果
- **编译**: ✅ 成功（使用 npx @tauri-apps/cli@2）
- **启动**: ✅ 成功（应用窗口已打开）
- **URL加载**: ✅ 成功（正在加载 http://test-otc.68chat.co/）
- **JS注入**: 待用户验证（打开开发者工具查看控制台日志）
- **设备指纹**: ✅ 已实现并自动添加到请求头
- **RSA加密**: ✅ 已实现，签名已加密

### 安全加固：RSA 非对称加密
**实现位置**: `src-tauri/src/crypto.rs`

**加密流程**:
1. 客户端生成签名数据：`timestamp|fingerprint|url_hash`
2. 使用内置 RSA 公钥加密签名数据
3. 将加密后的 Base64 字符串添加到请求头 `X-Client-Signature`

**验证流程**（Java 后端）:
1. 读取 `X-Client-Signature` 头
2. 使用 RSA 私钥解密签名数据
3. 验证时间戳（防重放攻击）
4. 验证设备指纹是否匹配
5. 可选：验证 URL 哈希

**密钥文件**:
- 公钥：已嵌入应用 (`src-tauri/src/crypto.rs`)
- 私钥：`private_key.pem`（⚠️ 仅用于服务端，已加入 .gitignore）

**Java 后端集成指南**: 详见 `KEYS_README.md`

### 请求头说明
| Header 名称 | 值示例 | 说明 |
|------------|--------|------|
| X-Client-Signature | `aGVsbG8gd29ybGQ...` | RSA 加密的签名（Base64） |
| X-Timestamp | `2025-11-24T14:00:00Z` | ISO8601 时间戳 |
| X-Device-Fingerprint | `550e8400-...` | 设备唯一指纹 |

## Java 后端集成完成

### 已完成的工作
- ✅ 生成 PKCS#8 格式私钥（Java 兼容）
- ✅ 复制私钥文件到 Java 项目 (`src/main/resources/private_key.pem`)
- ✅ 实现 `SafeVerifyInterceptor` 拦截器（完整的 RSA 解密验证逻辑）
- ✅ 拦截器已注册到 `WebConfig`（拦截所有请求）
- ✅ 更新 Rust 客户端公钥（与新私钥配对）

### 验证逻辑
1. 检查请求头是否包含 `X-Client-Signature`、`X-Timestamp`、`X-Device-Fingerprint`
2. 使用 RSA 私钥解密签名
3. 验证时间戳（防重放攻击，允许5分钟误差）
4. 验证设备指纹是否匹配
5. 验证 URL 哈希是否匹配

### 安全策略
- **拒绝策略**: 没有正确签名的请求返回 `403 Forbidden`
- **时间窗口**: 请求时间戳必须在 ±5 分钟内
- **日志记录**: 所有验证失败的请求会被记录（包含 IP 和指纹）

### 可选扩展（已预留代码）
在 `SafeVerifyInterceptor` 中搜索注释 `// 可选：检查设备指纹白名单`，可以添加数据库查询逻辑：
```java
if (!isDeviceWhitelisted(fingerprint)) {
    log.warn("Device not whitelisted: {}", fingerprint);
    return false;
}
```

## 架构说明
1. **拦截层 (`src/inject.js`)**:
   - 重写 `window.fetch` 和 `XMLHttpRequest`。
   - 将请求转发给 Tauri Command `proxy_request`。
2. **代理层 (`src-tauri/src/proxy.rs`)**:
   - 接收前端请求。
   - 添加 `X-Client-Verify` 头。
   - 维护 Cookie Jar (确保登录态)。
   - 转发请求至 Java 后端。
3. **配置层**:
   - `tauri.conf.json`: 开启 `withGlobalTauri`，指向远程 URL。
   - `capabilities/default.json`: 允许 IPC 通信。


